Definitions:

GET = “GET”
POST = “POST”		 	# other methods?
HTTP = “http”			# https?
COLON = “:”
SLASH = “/“
PREFIX = COLON SLASH SLASH
IP4BYTE = “0” - “255”
DOT = “.”
IP4 = IP4BYTE DOT IP4BYTE DOT IP4BYTE DOT IP4BYTE
# TODO - deferred
IP6 = refer to standard
# Section 11, http://www.ietf.org/rfc/rfc2181.txt
DNSOCTET = 0x0 - 0xFF
DNSLABEL = (DNSOCTET){1-63}
DNSNAME = (DNSLABEL DOT)* DNSLABEL [DOT] | [DOT] with a length of 0-255
HOSTNAME = IP4 | IP6 | DNSNAME
PORT = “1” - “65535”

TOR_BASE_URL = HTTP PREFIX HOSTNAME [ COLON PORT ] SLASH “tor” SLASH


Download from Directory Caches:

DL_BASE_URL = GET TOR_BASE_URL

Z = “.z”

PLUS = “+”

HEX_BYTE = “00” - “FF” | “00” - “ff”
# 6 uppercase characters is canonical
FINGERPRINT = ( HEX_BYTE ){1-20}

# A server (router or authority) identity key fingerprint
ID_FP = FINGERPRINT
# Due to squid proxy url limitations 
# at most 96 fingerprints (6-character?)
# can be retrieved in a single request.
ID_LIST = ID_FP ( PLUS ID_FP ){0-95}

DASH = “-“


# “microdesc” in spec, “micro” in digest path
FLAVOR = “ns” | “microdesc”

# “next” is for authorities only
STATUS = ( “current” | “next” )
STATUS_BASE_URL = DL_BASE_URL “status-vote” SLASH STATUS SLASH

STATUS_BASE_URL “consensus” [ Z ]
# Servers will only return a consensus if more than half of the requested
# authorities have signed the document, otherwise a 404 error
STATUS_BASE_URL “consensus” SLASH ID_LIST [ Z ]
STATUS_BASE_URL “consensus” DASH FLAVOR [ Z ]
STATUS_BASE_URL “consensus” DASH FLAVOR SLASH ID_LIST [ Z ]


# The spec is ambiguous here:
# Can we truncate the digests (like ID_FP), or not?
# How many digests are permitted? (due to squid?)
SIG_DIGEST = ( HEX_BYTE ){20}
SIG_DIGEST_LIST = SIG_DIGEST ( PLUS SIG_DIGEST ){0-??}

SERVER_BASE_URL = DL_BASE_URL “server” SLASH

SERVER_BASE_URL “fp” SLASH ID_LIST [ Z ]
SERVER_BASE_URL “d” SLASH SIG_DIGEST_LIST [ Z ]
# despite its name, the server authority 
# simply serves the local descriptor
SERVER_BASE_URL “authority” [ Z ]
SERVER_BASE_URL “all” [ Z ]


# We assume base64 from RFC 4648 here - but does everyone?
# A microdescriptor digest is SHA-256 encoded into 6-bit base64
# with no trailing equals signs 
BASE64_CHAR = “A” - “Z” | “a” - “z” | “0” - “9” | PLUS | SLASH
MICRO_DIGEST = ( BASE64_CHAR ){43}
# Due to squid proxy url limitations 
# at most 92 (43 character?) microdescriptor hashes 
# can be retrieved in a single request.

MICRO_LIST = MICRO_DIGEST ( DASH MICRO_DIGEST ){0-91}

DL_BASE_URL “micro” SLASH “d” SLASH MICRO_LIST [ Z ]


# A server (router or authority) signing key fingerprint
SK_FP = FINGERPRINT
# Due to squid proxy url limitations 
# at most 96 fingerprints (6-character?)
# can be retrieved in a single request.
SK_LIST = SK_FP ( PLUS SK_FP ){0-95}

# Squid proxy limitations are not specified, but 
# 48 x 2-part fingerprints would be equivalent to 
# 96 x 1-part fingerprints
ID_SK = ID_FP DASH SK_FP
ID_SK_LIST = ID_SK ( PLUS ID_SK ){0-47?}

KEYS_BASE_URL = DL_BASE_URL “keys” SLASH

# Are ID_LISTs or SK_LISTs permitted here?
KEYS_BASE_URL “fp” SLASH ID_FP [ Z ]
KEYS_BASE_URL “sk” SLASH SK_FP [ Z ]
KEYS_BASE_URL “fp-sk” SLASH ID_SK [ Z ]
KEYS_BASE_URL “fp-sk” SLASH ID_SK_LIST [ Z ]
KEYS_BASE_URL “all” [ Z ]


EXTRA_BASE_URL = DL_BASE_URL “extra” SLASH

# The spec is ambiguous:
# Is ID_LIST or just ID_FP permitted here?
EXTRA_BASE_URL “fp” SLASH ID_LIST [ Z ]
# Is SIG_DIGEST_LIST permitted here?
EXTRA_BASE_URL “d” SLASH SIG_DIGEST_LIST [ Z ]
EXTRA_BASE_URL “authority” [ Z ]
EXTRA_BASE_URL “all” [ Z ]


Download from Authorities Only:

KEYS_BASE_URL authority [ Z ]
# Votes of self, FP, and digest
STATUS_BASE_URL “authority” [ Z ]
STATUS_BASE_URL ID_FP [ Z ]
STATUS_BASE_URL “d” SLASH SIG_DIGEST [ Z ]
# Detached signatures
STATUS_BASE_URL “consensus-signatures” [ Z ]


Submission to Authorities:

POST_BASE_URL = POST TOR_BASE_URL
POST_BASE_URL					 # Descriptors
POST_BASE_URL “post” SLASH “vote”		 # Authority Votes
POST_BASE_URL “post” SLASH “consensus-signature” # Authority Detached Signatures
